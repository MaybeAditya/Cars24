<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yard Manager Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <div class="admin-container">
        <header class="admin-header">
            <div class="header-content">
                <h1 class="dashboard-title">
                    <i class="fas fa-user-tie"></i> Yard Manager Dashboard
                </h1>
                <div class="header-right">
                    <button class="refresh-btn" onclick="loadYardDashboard()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button class="logout-btn" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
        </header>

        <main class="admin-main">
            <!-- Overview Statistics -->
            <section class="stats-section">
                <div class="section-header">
                    <h2><i class="fas fa-chart-line"></i> My Hub Overview</h2>
                </div>
                <div class="stats-grid">
                    <div class="stat-card blue">
                        <div class="stat-icon"><i class="fas fa-car"></i></div>
                        <div class="stat-content">
                            <h3>Assigned Cars</h3>
                            <div class="stat-number" id="assigned-cars-count">Loading...</div>
                        </div>
                    </div>
                    <div class="stat-card green">
                        <div class="stat-icon"><i class="fas fa-video"></i></div>
                        <div class="stat-content">
                            <h3>Videos Uploaded</h3>
                            <div class="stat-number" id="uploaded-videos-count">Loading...</div>
                        </div>
                    </div>
                    <div class="stat-card purple">
                        <div class="stat-icon"><i class="fas fa-clock"></i></div>
                        <div class="stat-content">
                            <h3>Pending Audits</h3>
                            <div class="stat-number" id="pending-audits-count">Loading...</div>
                        </div>
                    </div>
                    <div class="stat-card red">
                        <div class="stat-icon"><i class="fas fa-chart-bar"></i></div>
                        <div class="stat-content">
                            <h3>Hub Adherence</h3>
                            <div class="stat-number" id="hub-adherence-rate">Loading...</div>
                            <div class="stat-subtitle">Performance Rate</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Assigned Cars -->
            <section class="table-section">
                <div class="section-header">
                    <h2><i class="fas fa-car"></i> Assigned Cars</h2>
                </div>
                <div class="table-container">
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th>Car Reg No</th>
                                <th>Hub Location</th>
                                <th>Status</th>
                                <th>Ground Worker</th>
                                <th>Upload Date</th>
                                <th>Audit Status</th>
                            </tr>
                        </thead>
                        <tbody id="assigned-cars-table">
                            <tr><td colspan="6" class="loading">Loading assigned cars...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Video Uploads -->
            <section class="table-section">
                <div class="section-header">
                    <h2><i class="fas fa-video"></i> Video Uploads</h2>
                </div>
                <div class="table-container">
                    <table class="modern-table">
                        <thead>
                            <tr>
                                <th>Car Reg No</th>
                                <th>Ground Worker</th>
                                <th>Upload Date</th>
                                <th>Audit Status</th>
                                <th>Rating</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="video-uploads-table">
                            <tr><td colspan="6" class="loading">Loading video uploads...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <script>
        // Load dashboard when page loads
        document.addEventListener('DOMContentLoaded', loadYardDashboard);

        // Main dashboard loader
        async function loadYardDashboard() {
            try {
                await Promise.all([
                    loadStats(),
                    loadAssignedCars(),
                    loadVideoUploads()
                ]);
            } catch (error) {
                console.error('Error loading yard dashboard:', error);
            }
        }

        // Load statistics
        async function loadStats() {
            try {
                const response = await fetch('/yard-stats');
                const stats = await response.json();
                
                document.getElementById('assigned-cars-count').textContent = stats.assigned_cars || 0;
                document.getElementById('uploaded-videos-count').textContent = stats.uploaded_videos || 0;
                document.getElementById('pending-audits-count').textContent = stats.pending_audits || 0;
                document.getElementById('hub-adherence-rate').textContent = (stats.adherence_rate || 0) + '%';
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load assigned cars
        async function loadAssignedCars() {
            try {
                const response = await fetch('/yard-video-assignments');
                const cars = await response.json();
                
                const tbody = document.getElementById('assigned-cars-table');
                if (cars.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="no-data">No cars assigned</td></tr>';
                    return;
                }
                
                tbody.innerHTML = cars.map(car => `
                    <tr>
                        <td><strong>${car.reg_no}</strong></td>
                        <td>${car.hub_location}</td>
                        <td><span class="badge ${getStatusClass(car.status)}">${car.status}</span></td>
                        <td>${car.ground_worker || 'Not assigned'}</td>
                        <td>${car.submission_date ? formatDate(car.submission_date) : 'Not uploaded'}</td>
                        <td><span class="badge ${getAuditStatusClass(car.audit_status)}">${car.audit_status || 'pending'}</span></td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading assigned cars:', error);
            }
        }

        // Load video uploads
        async function loadVideoUploads() {
            try {
                const response = await fetch('/yard-manager-videos');
                const videos = await response.json();
                
                const tbody = document.getElementById('video-uploads-table');
                if (videos.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="no-data">No videos uploaded yet</td></tr>';
                    return;
                }
                
                tbody.innerHTML = videos.map(video => `
                    <tr>
                        <td><strong>${video.reg_no}</strong></td>
                        <td>${video.ground_worker}</td>
                        <td>${formatDate(video.submission_date)}</td>
                        <td><span class="badge ${getAuditStatusClass(video.audit_status)}">${video.audit_status}</span></td>
                        <td>${video.audit_rating ? video.audit_rating + '/5 ‚≠ê' : 'Not rated'}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="viewVideoDetails(${video.id})">
                                <i class="fas fa-eye"></i> View
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading video uploads:', error);
            }
        }

        // Helper functions
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleDateString();
        }

        function getStatusClass(status) {
            switch (status) {
                case 'uploaded': return 'badge-success';
                case 'pending': return 'badge-warning';
                case 'overdue': return 'badge-danger';
                default: return 'badge-secondary';
            }
        }

        function getAuditStatusClass(status) {
            switch (status) {
                case 'approved': return 'badge-success';
                case 'rejected': return 'badge-danger';
                case 'pending': return 'badge-warning';
                default: return 'badge-secondary';
            }
        }

        function viewVideoDetails(videoId) {
            alert('Video details for ID: ' + videoId);
        }

        function logout() {
            fetch('/logout').then(() => window.location.href = '/');
        }
    </script>
</body>
</html>
